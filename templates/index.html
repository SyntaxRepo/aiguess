<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, shrink-to-fit=no">
    <title>Bingo Plus Game Predictor - AI Powered</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Bingo Plus Game Predictor</h1>
            <p>100% AI-Powered Strategic Analysis System</p>
            <p style="color: #ffd700; font-weight: bold;">üéØ NEW: Predicts TOP 3 COLORS!</p>
        </div>

        <div class="disclaimer">
            ‚ö†Ô∏è EDUCATIONAL PURPOSE ONLY - This demonstrates AI pattern analysis and game theory. 
            Gambling outcomes are random and cannot be reliably predicted. Please gamble responsibly.
        </div>

        <div class="game-container">
            <!-- Color Game -->
            <div class="game-card">
                <h2>üé® Color Game Predictor - TOP 3 PREDICTIONS</h2>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="label">Predictions</div>
                        <div class="value" id="color-predictions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Top Confidence</div>
                        <div class="value" id="color-confidence">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Pattern</div>
                        <div class="value" id="color-pattern">-</div>
                    </div>
                </div>

                <div class="color-grid" id="colorGrid">
                    <div class="color-box" style="background: #ff6b6b;" data-color="red">RED</div>
                    <div class="color-box" style="background: #51cf66;" data-color="green">GREEN</div>
                    <div class="color-box" style="background: #4dabf7;" data-color="blue">BLUE</div>
                    <div class="color-box" style="background: #ffd43b; color: #333;" data-color="yellow">YELLOW</div>
                    <div class="color-box" style="background: #ff8787;" data-color="pink">PINK</div>
                    <div class="color-box" style="background: #9775fa;" data-color="purple">PURPLE</div>
                </div>

                <button class="btn btn-primary" onclick="predictColor()" id="colorBtn">
                    üîÆ Get AI TOP 3 Predictions
                </button>

                <button class="btn btn-secondary" onclick="clearColorHistory()" id="colorClearBtn">
                    üóëÔ∏è Clear History
                </button>

                <div class="loading" id="colorLoading">
                    <div class="spinner"></div>
                    <p>ü§ñ AI analyzing patterns for TOP 3 colors...</p>
                </div>

                <div class="error-message" id="colorError" style="display: none;">
                    <p id="colorErrorText"></p>
                </div>

                <div class="prediction-result" id="colorResult">
                    <h3>‚ú® AI TOP 3 Predictions:</h3>
                    <div id="colorPrediction"></div>
                    <div class="ai-info">
                        <small>
                            ü§ñ Model: <span id="colorModel">-</span> | 
                            ‚è∞ <span id="colorTime">-</span>
                        </small>
                    </div>
                </div>

                <div class="history" id="colorHistory">
                    <strong>üìä Prediction History (<span id="color-history-count">0</span>):</strong>
                    <div id="colorHistoryList">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            No predictions yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Minesweeper Game -->
            <div class="game-card">
                <h2>üí£ Minesweeper Predictor</h2>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="label">Predictions</div>
                        <div class="value" id="mine-predictions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Safe Spots</div>
                        <div class="value" id="mine-safe">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Confidence</div>
                        <div class="value" id="mine-confidence">0%</div>
                    </div>
                </div>

                <div class="minesweeper-grid" id="mineGrid">
                    <!-- Generated by JavaScript -->
                </div>

                <button class="btn btn-primary" onclick="predictMines()" id="mineBtn">
                    üîÆ Get AI Prediction
                </button>

                <button class="btn btn-secondary" onclick="clearMineHistory()" id="mineClearBtn">
                    üóëÔ∏è Clear History
                </button>

                <div class="loading" id="mineLoading">
                    <div class="spinner"></div>
                    <p>ü§ñ AI analyzing mine patterns...</p>
                </div>

                <div class="error-message" id="mineError" style="display: none;">
                    <p id="mineErrorText"></p>
                </div>

                <div class="prediction-result" id="mineResult">
                    <h3>‚ú® AI Prediction Result:</h3>
                    <p id="minePrediction"></p>
                    <div class="ai-info">
                        <small>
                            ü§ñ Model: <span id="mineModel">-</span> | 
                            Safe: <span id="mine-safe-count">0</span> | 
                            Danger: <span id="mine-danger-count">0</span>
                        </small>
                    </div>
                </div>

                <div class="history" id="mineHistory">
                    <strong>üìä Prediction History (<span id="mine-history-count">0</span>):</strong>
                    <div id="mineHistoryList">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            No predictions yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Color Game State
        let colorPredictionCount = 0;
        let colorHistoryData = [];

        // Minesweeper State
        let minePredictionCount = 0;
        let mineHistoryData = [];

        // Initialize Minesweeper Grid
        function initMineGrid() {
            const grid = document.getElementById('mineGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'mine-cell';
                cell.textContent = i;
                cell.dataset.index = i;
                grid.appendChild(cell);
            }
        }

        // Clear Color History
        function clearColorHistory() {
            if (confirm('Are you sure you want to clear color prediction history?')) {
                colorHistoryData = [];
                colorPredictionCount = 0;
                
                document.getElementById('color-predictions').textContent = '0';
                document.getElementById('color-confidence').textContent = '0%';
                document.getElementById('color-pattern').textContent = '-';
                document.getElementById('color-history-count').textContent = '0';
                document.getElementById('colorHistoryList').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        No predictions yet
                    </div>
                `;
                document.getElementById('colorResult').classList.remove('show');
                
                // Remove predicted highlight
                document.querySelectorAll('.color-box').forEach(box => {
                    box.classList.remove('predicted', 'predicted-1', 'predicted-2', 'predicted-3');
                    box.style.border = '';
                    box.style.boxShadow = '';
                    box.innerHTML = box.innerHTML.split('<br>')[0]; // Remove rank badges
                });
                
                console.log('‚úÖ Color history cleared');
            }
        }

        // Clear Minesweeper History
        function clearMineHistory() {
            if (confirm('Are you sure you want to clear minesweeper prediction history?')) {
                mineHistoryData = [];
                minePredictionCount = 0;
                
                document.getElementById('mine-predictions').textContent = '0';
                document.getElementById('mine-safe').textContent = '0';
                document.getElementById('mine-confidence').textContent = '0%';
                document.getElementById('mine-history-count').textContent = '0';
                document.getElementById('mineHistoryList').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        No predictions yet
                    </div>
                `;
                document.getElementById('mineResult').classList.remove('show');
                
                // Reset grid
                initMineGrid();
                
                console.log('‚úÖ Minesweeper history cleared');
            }
        }

        // Helper function to get color code
        function getColorCode(colorName) {
            const colors = {
                'red': '#ff6b6b',
                'green': '#51cf66',
                'blue': '#4dabf7',
                'yellow': '#ffd43b',
                'pink': '#ff8787',
                'purple': '#9775fa'
            };
            return colors[colorName.toLowerCase()] || '#000';
        }

        // Predict Color Function - UPDATED FOR 3 PREDICTIONS
        async function predictColor() {
            const btn = document.getElementById('colorBtn');
            const loading = document.getElementById('colorLoading');
            const result = document.getElementById('colorResult');
            const errorDiv = document.getElementById('colorError');
            const errorText = document.getElementById('colorErrorText');
            const colorBoxes = document.querySelectorAll('.color-box');

            btn.disabled = true;
            loading.classList.add('show');
            result.classList.remove('show');
            errorDiv.style.display = 'none';
            
            // Clear previous predictions
            colorBoxes.forEach(box => {
                box.classList.remove('predicted', 'predicted-1', 'predicted-2', 'predicted-3');
                box.style.border = '';
                box.style.boxShadow = '';
                box.innerHTML = box.innerHTML.split('<br>')[0]; // Remove rank badges
            });

            try {
                console.log('üé® Requesting AI TOP 3 color predictions...');
                console.log('üìä History data:', colorHistoryData);
                
                const response = await fetch('/predict/color', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: colorHistoryData })
                });

                const data = await response.json();
                console.log('üì• AI Response:', data);

                loading.classList.remove('show');

                if (data.error || !response.ok) {
                    errorText.textContent = data.message || '‚ùå Prediction failed';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Check if we have multi-prediction format
                if (data.predictions && Array.isArray(data.predictions)) {
                    // NEW FORMAT: Handle 3 predictions
                    displayMultiplePredictions(data);
                } else if (data.prediction) {
                    // FALLBACK: Handle single prediction (backward compatibility)
                    displaySinglePrediction(data);
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                loading.classList.remove('show');
                errorText.textContent = `‚ùå Connection error: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        // Display Multiple Predictions (3 colors)
        function displayMultiplePredictions(data) {
            // Update stats with highest confidence
            colorPredictionCount++;
            document.getElementById('color-predictions').textContent = colorPredictionCount;
            document.getElementById('color-confidence').textContent = data.predictions[0].confidence + '%';
            document.getElementById('color-pattern').textContent = data.pattern || 'Multi-Strategy';

            // Build prediction display HTML
            let predictionHTML = '';
            
            // Process each prediction
            data.predictions.forEach((pred, index) => {
                const colorName = pred.color.toLowerCase();
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â';
                
                // Highlight the predicted color box
                const predictedBox = document.querySelector(`.color-box[data-color="${colorName}"]`);
                if (predictedBox) {
                    predictedBox.classList.add('predicted', `predicted-${rank}`);
                    
                    // Add visual ranking
                    if (rank === 1) {
                        predictedBox.style.border = '4px solid #ffd700';
                        predictedBox.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.8)';
                        predictedBox.innerHTML = predictedBox.innerHTML.split('<br>')[0] + `<br>${medal} #1`;
                    } else if (rank === 2) {
                        predictedBox.style.border = '3px solid #c0c0c0';
                        predictedBox.style.boxShadow = '0 0 20px rgba(192, 192, 192, 0.7)';
                        predictedBox.innerHTML = predictedBox.innerHTML.split('<br>')[0] + `<br>${medal} #2`;
                    } else if (rank === 3) {
                        predictedBox.style.border = '3px solid #cd7f32';
                        predictedBox.style.boxShadow = '0 0 15px rgba(205, 127, 50, 0.6)';
                        predictedBox.innerHTML = predictedBox.innerHTML.split('<br>')[0] + `<br>${medal} #3`;
                    }
                }
                
                // Add to prediction display
                predictionHTML += `
                    <div style="padding: 10px; margin: 8px 0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                border-radius: 8px; border-left: 4px solid ${getColorCode(colorName)};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.3em; color: ${getColorCode(colorName)};">
                                    ${medal} ${colorName.toUpperCase()}
                                </strong>
                                <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
                                    (${pred.strategy || 'Strategic Pick'})
                                </span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">
                                    ${pred.confidence}%
                                </div>
                                <small style="color: #999;">confidence</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add top prediction to history (only the first one)
                if (index === 0) {
                    colorHistoryData.push(pred.color);
                }
            });
            
            // Add reasoning if available
            if (data.reasoning) {
                predictionHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                        <strong>üí° AI Strategy:</strong> ${data.reasoning}
                    </div>
                `;
            }
            
            // Add analysis info if available
            if (data.analysis && data.analysis.history_length > 0) {
                predictionHTML += `
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        üìä Analysis based on ${data.analysis.history_length} rounds | 
                        Most common: ${data.analysis.most_common || 'N/A'} | 
                        Least common: ${data.analysis.least_common || 'N/A'}
                    </div>
                `;
            }

            // Display results
            document.getElementById('colorPrediction').innerHTML = predictionHTML;
            document.getElementById('colorModel').textContent = data.model_used || 'N/A';
            document.getElementById('colorTime').textContent = new Date(data.timestamp).toLocaleTimeString();
            document.getElementById('colorResult').classList.add('show');

            // Add to history
            addColorHistory(data, true); // true = multiple predictions
        }

        // Display Single Prediction (fallback)
        function displaySinglePrediction(data) {
            // Update stats
            colorPredictionCount++;
            document.getElementById('color-predictions').textContent = colorPredictionCount;
            document.getElementById('color-confidence').textContent = data.confidence + '%';
            document.getElementById('color-pattern').textContent = data.pattern || 'AI Analysis';

            // Highlight predicted color
            const predictedBox = document.querySelector(`.color-box[data-color="${data.prediction}"]`);
            if (predictedBox) {
                predictedBox.classList.add('predicted');
                predictedBox.style.border = '4px solid #ffd700';
                predictedBox.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.8)';
            }

            // Show result
            document.getElementById('colorPrediction').innerHTML = `
                <strong style="font-size: 1.8em; color: ${getColorCode(data.prediction)}; text-transform: uppercase;">
                    üéØ ${data.prediction}
                </strong><br><br>
                <strong>Confidence:</strong> ${data.confidence}%<br>
                <strong>Strategy:</strong> ${data.pattern}<br>
                <strong>AI Reasoning:</strong> ${data.reasoning}
            `;
            
            document.getElementById('colorModel').textContent = data.model_used || 'N/A';
            document.getElementById('colorTime').textContent = new Date(data.timestamp).toLocaleTimeString();
            document.getElementById('colorResult').classList.add('show');

            // Add to history
            colorHistoryData.push(data.prediction);
            addColorHistory(data, false);
        }

        // Add Color History Entry - UPDATED
        function addColorHistory(data, isMultiple = false) {
            const historyList = document.getElementById('colorHistoryList');
            
            // Remove "no predictions" message
            if (historyList.querySelector('div[style*="text-align: center"]')) {
                historyList.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            if (isMultiple && data.predictions) {
                // Format for multiple predictions
                const topColors = data.predictions.slice(0, 3).map((p, i) => 
                    `<span style="color: ${getColorCode(p.color)}; font-weight: bold;">
                        ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}${p.color.toUpperCase()}(${p.confidence}%)
                    </span>`
                ).join(' ');
                
                historyItem.innerHTML = `
                    ${topColors}
                    <span style="color: #999;"> - ${new Date(data.timestamp).toLocaleTimeString()}</span>
                    ${data.ai_powered ? '<span style="color: #4CAF50;"> ü§ñ AI</span>' : ''}
                    <br>
                    <small style="color: #666;">${data.pattern}</small>
                `;
            } else {
                // Format for single prediction
                historyItem.innerHTML = `
                    <span style="color: ${getColorCode(data.prediction)}; font-weight: bold; text-transform: uppercase;">
                        ${data.prediction}
                    </span>
                    <span style="color: #667eea;"> (${data.confidence}%)</span>
                    <span style="color: #999;"> - ${new Date(data.timestamp).toLocaleTimeString()}</span>
                    ${data.ai_powered ? '<span style="color: #4CAF50;"> ü§ñ AI</span>' : ''}
                    <br>
                    <small style="color: #666;">${data.pattern}</small>
                `;
            }
            
            historyList.insertBefore(historyItem, historyList.firstChild);

            // Keep last 10 items
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
            
            document.getElementById('color-history-count').textContent = colorPredictionCount;
        }

        // Predict Mines Function
        async function predictMines() {
            const btn = document.getElementById('mineBtn');
            const loading = document.getElementById('mineLoading');
            const result = document.getElementById('mineResult');
            const errorDiv = document.getElementById('mineError');
            const errorText = document.getElementById('mineErrorText');

            btn.disabled = true;
            loading.classList.add('show');
            result.classList.remove('show');
            errorDiv.style.display = 'none';
            
            // Reset grid
            const cells = document.querySelectorAll('.mine-cell');
            cells.forEach(cell => {
                cell.classList.remove('safe', 'danger');
                cell.textContent = cell.dataset.index;
            });

            try {
                console.log('üí£ Requesting AI minesweeper prediction...');
                
                const response = await fetch('/predict/minesweeper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                console.log('üì• AI Response:', data);

                loading.classList.remove('show');

                if (data.error || !response.ok) {
                    errorText.textContent = data.message || '‚ùå Prediction failed';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Update stats
                minePredictionCount++;
                document.getElementById('mine-predictions').textContent = minePredictionCount;
                document.getElementById('mine-safe').textContent = data.safe_spots.length;
                document.getElementById('mine-confidence').textContent = data.confidence + '%';
                document.getElementById('mine-safe-count').textContent = data.safe_spots.length;
                document.getElementById('mine-danger-count').textContent = data.danger_spots.length;

                // Mark safe spots
                data.safe_spots.forEach(index => {
                    const cell = document.querySelector(`.mine-cell[data-index="${index}"]`);
                    if (cell) {
                        cell.classList.add('safe');
                        cell.textContent = '‚úì';
                    }
                });

                // Mark danger spots
                data.danger_spots.forEach(index => {
                    const cell = document.querySelector(`.mine-cell[data-index="${index}"]`);
                    if (cell) {
                        cell.classList.add('danger');
                        cell.textContent = 'üí£';
                    }
                });

                // Show result
                document.getElementById('minePrediction').innerHTML = `
                    <strong style="color: #4CAF50;">‚úì Safe Spots:</strong> ${data.safe_spots.length} cells<br>
                    <strong style="color: #f44336;">üí£ Danger Zones:</strong> ${data.danger_spots.length} cells<br>
                    <strong>Confidence:</strong> ${data.confidence}%<br>
                    <strong>AI Strategy:</strong> ${data.reasoning}
                `;
                
                document.getElementById('mineModel').textContent = data.model_used || 'N/A';
                
                result.classList.add('show');

                // Add to history
                addMineHistory(data);

            } catch (error) {
                console.error('‚ùå Error:', error);
                loading.classList.remove('show');
                errorText.textContent = `‚ùå Connection error: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        // Add Mine History Entry
        function addMineHistory(data) {
            const historyList = document.getElementById('mineHistoryList');
            
            // Remove "no predictions" message
            if (historyList.querySelector('div[style*="text-align: center"]')) {
                historyList.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <span style="color: #4CAF50;">‚úì ${data.safe_spots.length}</span> safe, 
                <span style="color: #f44336;">üí£ ${data.danger_spots.length}</span> danger
                <span style="color: #667eea;"> (${data.confidence}%)</span>
                <span style="color: #999;"> - ${new Date(data.timestamp).toLocaleTimeString()}</span>
                ${data.ai_powered ? '<span style="color: #4CAF50;"> ü§ñ AI</span>' : ''}
            `;
            historyList.insertBefore(historyItem, historyList.firstChild);

            // Keep last 10 items
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
            
            document.getElementById('mine-history-count').textContent = minePredictionCount;
        }

        // Initialize on page load
        window.onload = function() {
            console.log('üéÆ AI Game Predictor Loaded - TOP 3 COLOR PREDICTION ENABLED');
            console.log('üìä Pattern Analysis & Game Theory Enabled');
            console.log('üéØ Now predicting TOP 3 colors for better odds!');
            initMineGrid();
        };
    </script>
</body>
</html>
